<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="https://pbs.twimg.com/profile_images/1614420813800767490/mf6sQbCT_400x400.jpg" type="image/png">
<title>quasimatt.com social graph</title>

<style>
  :root { --bg:#000; --fg:#fff; --muted:#aaa; }

  html,body {
    margin:0;
    height:100%;
    background:var(--bg);
    color:var(--fg);
    font-family:"Helvetica Neue", Helvetica, Arial, system-ui, -apple-system, sans-serif;
  }

  a { color:var(--fg); text-decoration:underline; }

  /* ✅ checkbox color fix */
  input[type="checkbox"] {
    accent-color: #fff;
  }

  .wrap { display:grid; grid-template-rows:auto 1fr; height:100%; }

  header {
    padding:12px 16px;
    border-bottom:1px solid #222;
    display:flex;
    align-items:center;
    gap:14px;
    flex-wrap:wrap;
    position: sticky;
    top: 0;
    z-index: 1000;
    background: #000;
  }

  header h1 {
    font-size:16px;
    margin:0;
    letter-spacing:.2px;
    font-weight:600;
  }

  header .controls {
    display:flex;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
    color:var(--muted);
  }

  label { font-size:12px; }
  .hint { font-size:12px; color:var(--muted); }

  #graph {
    position:relative;
    width:100%;
    height:calc(100vh - 60px);
    overflow: hidden;
    touch-action: none;
  }

  canvas {
    display:block;
    width:100%;
    height:100%;
    background:#000;
  }

  .tooltip {
    position:fixed;
    pointer-events:none;
    background:#000;
    color:#fff;
    padding:6px 8px;
    border:1px solid #333;
    border-radius:8px;
    font-size:12px;
    white-space:nowrap;
    transform:translate(-50%,-140%);
    display:none;
    z-index:999999;
  }

  .error { color:#f66; font-size:12px; margin-left:8px; }

  .mentions-control {
    display:flex;
    flex-direction:column;
    gap:4px;
  }

  .mentions-control span { font-size:12px; }

  .mentions-range {
    position:relative;
    width:180px;
    height:24px;
  }

  .mentions-bar {
    position:absolute;
    left:0;
    right:0;
    top:50%;
    transform:translateY(-50%);
    height:6px;
    background:#333;
    border-radius:3px;
  }

  .mentions-range input[type="range"] {
    position:absolute;
    left:0;
    top:0;
    width:100%;
    height:24px;
    margin:0;
    background:transparent;
    pointer-events:none;
    -webkit-appearance:none;
    appearance:none;
  }

  .mentions-range input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance:none;
    pointer-events:auto;
    height:14px;
    width:14px;
    border-radius:50%;
    background:#fff;
    border:1px solid #999;
  }

  .mentions-range input[type="range"]::-moz-range-thumb {
    pointer-events:auto;
    height:14px;
    width:14px;
    border-radius:50%;
    background:#fff;
    border:1px solid #999;
  }

  #minMentions { z-index:2; }
  #maxMentions { z-index:3; }
</style>
</head>

<body>
<div class="wrap">
  <header>
    <h1><a href="https://quasimatt.com/social">quasimatt.com/social</a>/graph</h1>

    <div class="controls">
      <div class="mentions-control">
        <span>mentions: <span id="mentionsLabel">3–10</span></span>
        <div class="mentions-range">
          <div class="mentions-bar"></div>

          <!-- ✅ default min = 3 -->
          <input id="minMentions" type="range" min="1" max="10" value="3" step="1" />
          <input id="maxMentions" type="range" min="1" max="10" value="10" step="1" />
        </div>
      </div>

      <label><input type="checkbox" id="showEdges" checked> show edges</label>
      <label><input type="checkbox" id="showLabels" checked> show labels</label>
      <label>since: <strong>2025-09-22</strong></label>

      <span class="hint">(zoom: scroll, pan: drag.)</span>
      <span id="status" class="hint"></span>
      <span id="error" class="error"></span>
    </div>
  </header>

  <div id="graph">
    <canvas id="c"></canvas>
    <div id="tooltip" class="tooltip"></div>
  </div>
</div>

<script>
(function () {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const statusEl = document.getElementById('status');
  const errEl = document.getElementById('error');
  const graphEl = document.getElementById('graph');

  const minMentionsInput = document.getElementById('minMentions');
  const maxMentionsInput = document.getElementById('maxMentions');
  const mentionsLabel = document.getElementById('mentionsLabel');

  let rawPosts = [];
  let nodes = [], links = [];
  let globalMaxMentions = 1;
  let firstCompute = true;

  function setStatus(s){ statusEl.textContent = s; }

  function fitCanvas() {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const w = canvas.parentElement.clientWidth;
    const h = canvas.parentElement.clientHeight;
    canvas.width = w * dpr;
    canvas.height = h * dpr;
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }

  async function loadSocial() {
    const res = await fetch('/social');
    const html = await res.text();
    const doc = new DOMParser().parseFromString(html, 'text/html');

    const ps = [...doc.querySelectorAll('p[data-type="social"][data-date]')];
    rawPosts = ps.map(p => ({
      ids: [...p.querySelectorAll('a[href]')].map(a => a.href)
    }));
  }

  function recomputeAndRender() {
    const mentionTotals = new Map();
    for (const p of rawPosts) {
      for (const id of p.ids) {
        mentionTotals.set(id, (mentionTotals.get(id) || 0) + 1);
      }
    }

    const vals = [...mentionTotals.values()];
    globalMaxMentions = vals.length ? Math.max(...vals) : 1;

    minMentionsInput.max = globalMaxMentions;
    maxMentionsInput.max = globalMaxMentions;

    let minVal = parseInt(minMentionsInput.value, 10);
    let maxVal = parseInt(maxMentionsInput.value, 10);

    /* ✅ default to 3–max on first load */
    if (firstCompute) {
      minVal = Math.min(3, globalMaxMentions);
      maxVal = globalMaxMentions;
      firstCompute = false;
    }

    minVal = Math.max(1, Math.min(minVal, globalMaxMentions));
    maxVal = Math.max(1, Math.min(maxVal, globalMaxMentions));
    if (minVal > maxVal) [minVal, maxVal] = [maxVal, minVal];

    minMentionsInput.value = minVal;
    maxMentionsInput.value = maxVal;
    mentionsLabel.textContent = `${minVal}–${maxVal}`;

    setStatus(`mentions range: ${minVal}–${maxVal}`);
  }

  (async function init(){
    try {
      fitCanvas();
      await loadSocial();
      recomputeAndRender();
    } catch (e) {
      errEl.textContent = e.message;
    }
  })();

  minMentionsInput.addEventListener('input', recomputeAndRender);
  maxMentionsInput.addEventListener('input', recomputeAndRender);
})();
</script>
</body>
</html>

